{% extends "base.html" %} {% block title %}Batch Upload | WriteGPT{% endblock %}
{% block content %}

<div class="container mx-auto py-12 flex flex-col items-center">
    <div class="flex items-center bg-blue-500 text-white text-sm font-bold px-4 py-3 hide"
         id="success-msg" role="alert">
      <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M12.432 0c1.34 0 2.01.912 2.01 1.957 0 1.305-1.164 2.512-2.679 2.512-1.269 0-2.009-.75-1.974-1.99C9.789 1.436 10.67 0 12.432 0zM8.309 20c-1.058 0-1.833-.652-1.093-3.524l1.214-5.092c.211-.814.246-1.141 0-1.141-.317 0-1.689.562-2.502 1.117l-.528-.88c2.572-2.186 5.531-3.467 6.801-3.467 1.057 0 1.233 1.273.705 3.23l-1.391 5.352c-.246.945-.141 1.271.106 1.271.317 0 1.357-.392 2.379-1.207l.6.814C12.098 19.02 9.365 20 8.309 20z"/></svg>
      <p>Success! Your file has been uploaded. We will email you when its completed.</p>
    </div>
    <div class="container mx-auto grid grid-cols-2 gap-8" >
        <div class="rounded-lg shadow-lg p-8 flex flex-col" style="height:243px; margin-left;10px;">
                <h2 class="text-xl text-gray-800 font-semibold mb-4" >BATCH UPLOAD</h2>
             <ul class="text-m text-gray-500 font-semibold mb-4">
                 <li>Only csv formats are accepted</li>
                 <li>It should contain columns url,sender_info,recipient_info,word_count</li>
                 <li>Optional columns : search_on_google(True/False), prompt, template, knowledge_base</li>
                 <li>It will generate the output for all and write it to the csv file</li>
             </ul>
        </div>

         <form id="upload_form" class="rounded-lg shadow-lg p-8 mb-4" method="post"
               action="/api/batch_upload" enctype="multipart/form-data"  style="margin-right:10px;">
              <label class="text-m text-gray-800 font-semibold mb-10" for="batch_csvfile">Select a CSV file to upload:</label><br><br><br>
              <input accept=".csv" type="file" id="batch_csvfile" name="batch_csvfile"><br>
              <div class="mb-4">
                <button
                    id="submit-form-btn"
                    class="mt-5 bg-blue-500 hover:bg-blue-700 text-white font-bold
                     py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline"
                >
                    Upload
                </button>
            </div>
         </form>
    </div>

    <div class="container mx-auto grid grid-cols-1 align-middle bg-white" style="padding:50px; margin: 0 auto;">
        <div class="overflow-x-auto align-middle hide" id="upload_table" style="margin: 0 auto;">
        <h2 class="text-2xl font-bold mb-4">Upload STATUS</h2>
        <!--Table-->
       <table class="table-auto w-full" style="width:700px;">

              <!--Table head-->
                <thead>
                    <tr>
                      <th class="px-4 py-2 text-left align-middle">File Name</th>
                      <th class="px-4 py-2 text-left align-middle">Created AT</th>
                      <th class="px-4 py-2 text-left align-middle">Status</th>
                      <th class="px-4 py-2 text-left align-middle">URL</th>
                    </tr>
              </thead>
              <!--Table head-->

              <!--Table body-->
              <tbody id="table_rows">
<!--                <tr class="table-info">-->
<!--                      <td class="border px-4 py-2 align-middle" id="filename">Test.csv</td>-->
<!--                      <td class="border px-4 py-2 align-middle" id="created">14 March 2023</td>-->
<!--                      <td class="border px-4 py-2 align-middle" id="status">In progress</td>-->
<!--&lt;!&ndash;                      <td class="border px-4 py-2 align-middle" id="url" width="40px">https://storage.googleapis.com/writegpt-cai.appspot.com/WriteGPT%20Format%20-%20Input%20Format-output2023-03-24%2023%3A08%3A35.744243.csv</td>&ndash;&gt;-->
<!--                    <td class="border px-4 py-2 align-middle" id="url" width="40px">-</td>-->
<!--                </tr>-->
              </tbody>
              <!--Table body-->


        </table>
        <!--Table-->
    </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script>

    function getJwtToken() {
        // Read the JWT token from the localStorage
        return localStorage.getItem("jwtToken");
    }

    window.onload = function () {
        const jwtToken = getJwtToken();
        if (!jwtToken) {

            window.location.href = "/signup";
            return;
        }else{
            get_data_from_userID();
        }

    };

    var interval;
    const jwtToken = localStorage.getItem("jwtToken");

    $("form#upload_form").submit(function(e) {
        e.preventDefault();
        var formData = new FormData(this);

        var validate = validate_file();
            if(validate){
                $.ajax({
                    url: "/api/batch_upload",
                    type: 'POST',
                    data: formData,
                    beforeSend: function (xhr) {
                            xhr.setRequestHeader('Authorization', 'Bearer '+jwtToken);
                        },
                    success: function (data) {
                        $("#success-msg").removeClass("hide");
                        $("#success-msg").fadeTo(2000, 2500).slideUp(2500, function(){
                            $("#success-msg").slideUp(2500);
                        });
                        interval = setInterval( function() { get_data_from_docID(data["documentID"]); }, 10000);

                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
          }
    });

    function get_data_from_docID(docID){
        //console.log("docID "+docID);
            $.ajax({
                    url: "/api/batch_upload/fetch_upload_progress_report?docID="+docID,
                    type: 'GET',
                    beforeSend: function (xhr) {
                            xhr.setRequestHeader('Authorization', 'Bearer '+jwtToken);
                        },
                    success: function (data) {
                       console.log(data["data"]);
                       result = data["data"];
                       status = result["status"];
                       $(".attached_row").remove();
                       $("#table_rows").prepend('<tr class="table-info attached_row"><td class="border px-4 py-2 align-middle">'+result["filename"]+'</td><td class="border px-4 py-2 align-middle">'+result["created_at"]+'</td><td class="border px-4 py-2 align-middle">'+result["status"]+'</td><td class="border px-4 py-2 align-middle">'+result["url"]+'</td></tr>');
                       $("#upload_table").removeClass('hide');
                       if(status == "Success"){
                            clearInterval(interval);
                       }
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
    }

    function validate_file(){
            var file = document.getElementById("batch_csvfile");
            if( file.files.length == 0 ){
                alert("no files selected");
                 return 0;
            }
            var extension = file.files[0].type;
            if( extension != "text/csv" ){
                alert("Please upload csv files only.");
                return 0;
            }

            return 1;
    }

    function get_data_from_userID(){
        console.log("userId api ");
            $.ajax({
                    url: "/api/batch_upload/fetch_upload_progress_report?userID=true",
                    type: 'GET',
                    beforeSend: function (xhr) {
                            xhr.setRequestHeader('Authorization', 'Bearer '+jwtToken);
                        },
                    success: function (data) {
                       console.log("success results "+data["data"]);
                       all_results = data["data"];
                       for (let i = 0; i < all_results.length; i++) {
                            result = all_results[i];
                            $("#table_rows").last().append('<tr class="table-info"><td class="border px-4 py-2 align-middle">'+result["filename"]+'</td><td class="border px-4 py-2 align-middle">'+result["created_at"]+'</td><td class="border px-4 py-2 align-middle">'+result["status"]+'</td><td class="border px-4 py-2 align-middle">'+result["url"]+'</td></tr>');
                            $("#upload_table").removeClass('hide');
                        }
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
    }




</script>
{% endblock %}